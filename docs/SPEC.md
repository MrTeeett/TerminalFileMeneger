# Terminal File Manager (Go) — Спецификация

> Версия документа: 0.1 (черновик). Предназначен для согласования видения, приоритетов и архитектуры перед реализацией.

## Назначение
Быстрый, удобный и расширяемый терминальный файловый менеджер (TUI) для Linux, пригодный для локальной работы и по SSH. Цель — глубокая кастомизация через конфиг, бинды, темы, макросы и внешние команды/плагины.

## Базовые решения по умолчанию
- TUI-стек: Bubble Tea + Bubbles + Lip Gloss.
- Формат конфига: TOML (`~/.config/tfm/config.toml`).
- Стиль биндов: Vim-подобный (с возможностью полного ремаппинга).
- Имя бинарника/проекта: `tfm` (Terminal File Manager).

## Цели
- Производительность: отзывчивый интерфейс на больших директориях; фоновые операции; минимальная задержка ввода.
- Юзабилити: предсказуемые действия; командная палитра; понятный статус; удобная навигация одной рукой.
- Кастомизация: темы, бинды, макросы, внешние команды; горячая перезагрузка конфига.
- Надежность: устойчивость к ошибкам файловой системы; корректная работа с правами, симлинками и спец-файлами.

## Нефункциональные требования
- Платформы: Linux x86_64/arm64; популярные терминалы (xterm, kitty, wezterm, alacritty).
- Поставляется одним статически линкованным бинарником (без CGO по умолчанию).
- Четкие сообщения об ошибках; отсутствие паник в нормальной эксплуатации.
- Логи: `~/.cache/tfm/logs/` с дневной ротацией и уровнем по флагу CLI.

## Функции MVP
- Панели и вкладки
  - Одиночная и двухпанельная раскладка (левая/правая).
  - Минимум 2 вкладки с независимыми текущими директориями.
- Навигация
  - Стрелки и Vim-клавиши (h/j/k/l), Home/End, PageUp/PageDown.
  - Переход по истории (назад/вперед), быстрый `cd` к родителю.
  - Показ/скрытие скрытых файлов (dotfiles) toggle.
  - Закладки (bookmarks) и быстрые переходы.
- Операции с файлами
  - Копирование, перемещение, удаление (с подтверждением/«корзиной»), переименование.
  - Создание: `mkdir`, `touch`.
  - Массовые операции по выделению.
- Очередь задач
  - Фоновые операции с прогрессом, возможностью отмены и ограничением параллелизма.
- Поиск и фильтрация
  - Инкрементальный фильтр в текущем листинге.
  - Fuzzy-поиск по именам (ограничение по времени и количеству).
- Предпросмотр
  - Текст/hex/метаданные; для бинарей — краткая сводка.
  - Для изображений в MVP — метаданные (расширенный графический предпросмотр позже).
- Командная палитра
  - Единая точка вызова встроенных и пользовательских команд; автодополнение.

## Глубокая кастомизация
- Конфигурация (`~/.config/tfm/config.toml`)
  - Тема: цвета/стили, символы рамок, индикаторы, формат строки статуса.
  - Горячие клавиши: полное переназначение; режимы (normal/insert/command); поддержка chord-комбинаций.
  - Макросы: последовательности действий с параметрами и плейсхолдерами.
  - Внешние команды: шаблоны с переменными `{path}`, `{selection}`, `{cwd}`, `{pane}`; запуск через `$SHELL`.
- Плагины
  - Этап 1: внешние скрипты с простым JSON-протоколом по stdin/stdout.
  - Этап 2 (опционально): Go-плагины, если понадобится; предупреждение о совместимости ABI.
- Горячая перезагрузка конфига и темы при изменении файла.

## Архитектура и модули
- TUI-ядро: Bubble Tea модель (Model, Msg, Update, View).
- Основные пакеты
  - `app`: главный цикл, маршрутизация событий, сохранение/восстановление состояния.
  - `ui/panels`: листинг директорий, выделение, сортировка, фильтрация.
  - `ui/preview`: провайдеры предпросмотра (текст/hex/метаданные), адаптеры по типам.
  - `ui/commands`: командная палитра, регистрация и выполнение команд.
  - `fs/ops`: очередь задач, воркеры копирования/перемещения/удаления, прогресс и отмена.
  - `config`: загрузка TOML, валидация, горячая перезагрузка.
  - `keymap`: биндинг клавиш, режимы, chords, конфликт-детектор.
  - `theme`: модель темы, стили, пресеты.
  - `plugins`: запуск внешних команд, IPC (stdin/stdout), таймауты и песочница окружения.
  - `logging`: адаптер поверх `log/slog` или `zap` (решить на этапе реализации).
- Конкурентность
  - `context.Context` для отмены; каналы для очереди задач; дебаунс ввода.
  - Ограничение I/O при копировании (воркер-пул, семафоры).

## CLI и запуск
- Бинарник: `tfm`
- Флаги: `--config`, `--log-level`, `--version`, `--working-dir`.
- Конфиг по умолчанию генерируется при первом запуске, если отсутствует.

## Безопасность и защита от ошибок
- Проверка прав; аккуратная работа с симлинками; защита от directory traversal.
- Подтверждение опасных операций; «корзина» (перемещение в `~/.local/share/Trash`).
- Никакого `sudo` внутри приложения; повышенные права — вне утилиты.

## Производительность
- Ленивое чтение директории, кэширование `os.FileInfo`/расширенной статистики.
- Параллельное копирование с лимитом I/O и отображением прогресса.
- Fuzzy-поиск с ограничением времени; инкрементальный индекс в рамках панели.

## Формат плагин-протокола (черновик)
- Запуск: внешний процесс, получает JSON-команду на stdin, пишет JSON-ответ на stdout.
- Базовые сообщения
  - Request `{ "op": "list-actions" }` → Response `{ "actions": ["preview", "custom-op", ...] }`
  - Request `{ "op": "preview", "path": "/abs/file" }` → Response `{ "kind": "text", "content": "...", "mime": "text/plain" }`
  - Request `{ "op": "run", "action": "custom-op", "args": {...} }` → Response `{ "ok": true, "message": "..." }`
- Таймаут и ограничение вывода; изоляция переменных окружения.

## План этапов
- Этап 1 (MVP)
  - Каркас TUI, 1–2 панели, базовая навигация.
  - Операции: копирование/перемещение/удаление/переименование/создание.
  - Конфиг, бинды (Vim по умолчанию), командная палитра, логирование.
- Этап 2
  - Предпросмотр (текст/hex/метаданные), поиск/fuzzy, очередь задач с прогрессом.
  - История, закладки, улучшения UX, горячая перезагрузка темы/конфига.
- Этап 3
  - Внешние команды/плагины, вкладки/сессии, профилирование, полировка.

## Открытые вопросы
- TUI-стек: оставить Bubble Tea или рассмотреть tcell как альтернативу для низкоуровневого контроля?
- Конфиг: строго TOML или добавить YAML/JSON парсинг?
- Стандартные бинды: Vim, Emacs или смешанный профиль — что выбрать по умолчанию?
- Предпросмотр изображений в терминале: интеграция с `chafa`/`ueberzugpp` сразу или позже?

## Следующие шаги (после утверждения)
1) Инициализация `go mod` и базовой структуры каталогов (`cmd/tfm`, `internal/...`).
2) Подключение Bubble Tea/Bubbles/Lip Gloss; вывод «Hello TUI».
3) Черновик конфига и keymap, загрузка из TOML.
4) Каркас панелей и минимальной навигации.

---
Этот документ — рабочий черновик. Предлагайте правки: термины, приоритеты, UX, стек библиотек.


Подключить Bubble Tea/Bubbles/Lip Gloss и сделать минимальный экран (список файлов).
Реализовать парсер TOML для config и горячую перезагрузку.
Добавить очередь операций с прогрессом в fs/ops.
Согласовать дефолтную раскладку и тему.